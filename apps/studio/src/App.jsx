import React, { Suspense, lazy, useEffect } from "react";
import { BrowserRouter as Router, Routes, Route } from "react-router-dom";
import SimpleLayout from "./layouts/SimpleLayout.jsx";
import { getNavigationSections, getAppBarConfig } from "./config/navigation.js";
import { ROUTES } from "./config/routes.js";
import { loadMermaidLibrary } from "./utils/mermaidLoader.js";
import { initializeApp } from "./db/operations/lifecycleOps.js";

// Load preview routes (auto-generated by genPageConfig)
let PREVIEW_ROUTES = [];
try {
  const previewModule = await import("./config/preview-routes.js");
  PREVIEW_ROUTES = previewModule.PREVIEW_ROUTES || [];
} catch (error) {
  console.warn('⚠️ No preview routes found - preview-routes.js not generated yet');
}

// Import Studio page directly for full-screen rendering
const StudioPage = lazy(() => import("./pages/Studio/index.jsx"));
const DBBrowser = lazy(() => import("./pages/DBBrowser/index.jsx"));

const App = () => {
  // App startup initialization
  useEffect(() => {
    const startup = async () => {
      // Load master data (eventTypes, eventSQL, triggers) from MySQL into IndexedDB
      await initializeApp();

      // Load mermaid.js globally for Studio
      await loadMermaidLibrary().catch(console.error);

      console.log('✅ Studio App: Startup complete');

      // Register global selectEventTypeTab function for mermaid
      window.selectEventTypeTab = (nodeId) => {
        console.log(`🎯 App: selectEventTypeTab called with: ${nodeId}`);
        console.log('🔧 selectEventTypeTab function registered globally');
      };
    };

    startup();
  }, []);

  // Studio-specific route generation
  const generateRoutes = () => {
    return Object.entries(ROUTES).map(([routeKey, route]) => {
      // Lazy load each page component
      const PageComponent = lazy(() => import(`./pages/${route.component}`));

      return (
        <Route
          key={routeKey}
          path={route.path}
          element={
            <Suspense fallback={<div>Loading {route.title || route.component}...</div>}>
              <PageComponent
                mode="studio"
              />
            </Suspense>
          }
        />
      );
    });
  };

  // Generate preview routes dynamically
  const generatePreviewRoutes = () => {
    return PREVIEW_ROUTES.map((route) => {
      const PreviewComponent = lazy(() => import(`./${route.component}`));

      return (
        <Route
          key={route.path}
          path={route.path}
          element={
            <Suspense fallback={<div>Loading Preview: {route.title}...</div>}>
              <PreviewComponent />
            </Suspense>
          }
        />
      );
    });
  };

  return (
    <Router>
      <Routes>
        {/* Studio route - full screen, no SimpleLayout */}
        <Route
          path="/studio"
          element={
            <Suspense fallback={<div>Loading Studio...</div>}>
              <StudioPage mode="studio" />
            </Suspense>
          }
        />

        {/* DB Browser route - full screen */}
        <Route
          path="/db-browser"
          element={
            <Suspense fallback={<div>Loading DB Browser...</div>}>
              <DBBrowser />
            </Suspense>
          }
        />

        {/* Login route - test database-driven rendering */}
        <Route
          path="/login"
          element={
            <Suspense fallback={<div>Loading Login...</div>}>
              <div style={{ padding: "20px" }}>
                {React.createElement(lazy(() => import("./pages/Login/index.jsx")))}
              </div>
            </Suspense>
          }
        />

        {/* Preview routes - database-generated pages (no layout) */}
        {generatePreviewRoutes()}

        {/* All other routes use SimpleLayout */}
        <Route
          path="/*"
          element={
            <SimpleLayout
              navigationSections={getNavigationSections()}
              appBarConfig={getAppBarConfig()}
              appName="WhatsFresh Studio"
              onLogout={() => {
                console.log("Studio logout clicked");
              }}
            >
              <Routes>
                {/* Default route */}
                <Route
                  path="/"
                  element={
                    <div style={{ padding: "20px" }}>
                      <h1>WhatsFresh Studio</h1>
                      <p>Visual EventType Design & Development Environment</p>
                      <p>Navigate to Studio to start designing your eventTypes.</p>
                    </div>
                  }
                />
              </Routes>
            </SimpleLayout>
          }
        />
      </Routes>
    </Router>
  );
};

export default App;